<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVD & Price Realtime</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.44.0/apexcharts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 35, 60, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        h1 {
            font-size: 28px;
            color: #00d4ff;
        }

        .status {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            padding: 8px 16px;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff4444;
            border-radius: 8px;
            color: #ff4444;
            font-weight: 600;
        }

        .status-indicator.connected {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            color: #00ff88;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 8px;
            color: #00ff88;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(30, 35, 60, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8b9dc3;
            margin-bottom: 15px;
        }

        .metrics {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .label {
            font-size: 13px;
            color: #8b9dc3;
        }

        .value {
            font-size: 18px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .value.positive {
            color: #00ff88;
        }

        .value.negative {
            color: #ff4444;
        }

        .chart-card {
            grid-column: span 2;
        }

        @media (max-width: 1024px) {
            .chart-card {
                grid-column: span 1;
            }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        button.reset {
            background: #ef4444;
        }

        button.reset:hover {
            background: #dc2626;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #8b9dc3;
        }

        .volume-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .volume-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .volume-label {
            font-size: 13px;
            color: #8b9dc3;
        }

        .volume-progress {
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            transition: width 0.3s;
        }

        .volume-fill.buy {
            background: linear-gradient(90deg, #00ff88, #00cc6f);
        }

        .volume-fill.sell {
            background: linear-gradient(90deg, #ff4444, #cc3333);
        }

        .volume-value {
            font-size: 13px;
            color: #8b9dc3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ’Ž CVD & Price Realtime</h1>
            <div class="status">
                <span id="status" class="status-indicator">âš« Connecting...</span>
                <span id="symbol">BTC/USDT</span>
                <span id="liveIndicator" class="live-indicator" style="display: none;">
                    <span class="live-dot"></span>
                    LIVE
                </span>
            </div>
        </header>

        <div class="info-box">
            ðŸ“Š Realtime CVD (Cumulative Volume Delta) tracking from Binance â€¢ Auto-updating every candle close â€¢ Left axis: CVD | Right axis: Price
        </div>

        <div class="controls">
            <button id="startBtn" onclick="startTracking()">Start Tracking</button>
            <button id="stopBtn" onclick="stopTracking()" disabled>Stop Tracking</button>
            <button id="resetBtn" class="reset" onclick="resetChart()">Reset Data</button>
            <button onclick="exportCSV()">Export CSV</button>
        </div>

        <div class="grid">
            <!-- Current Metrics -->
            <div class="card">
                <h2>Current Metrics</h2>
                <div class="metrics">
                    <div class="metric">
                        <span class="label">Price</span>
                        <span class="value positive" id="price">-</span>
                    </div>
                    <div class="metric">
                        <span class="label">CVD Total</span>
                        <span class="value" id="cvd">-</span>
                    </div>
                    <div class="metric">
                        <span class="label">Delta (Current)</span>
                        <span class="value" id="delta">-</span>
                    </div>
                    <div class="metric">
                        <span class="label">Trades</span>
                        <span class="value" id="trades">-</span>
                    </div>
                </div>
            </div>

            <!-- Price & CVD Chart (Dual Axis) -->
            <div class="card chart-card">
                <h2>Price & CVD Chart (Dual Axis)</h2>
                <div id="combinedChart" style="height: 450px;"></div>
            </div>

            <!-- Delta Chart -->
            <div class="card chart-card">
                <h2>CVD Delta (Buy/Sell Pressure)</h2>
                <div id="deltaChart" style="height: 300px;"></div>
            </div>

            <!-- Volume Analysis -->
            <div class="card">
                <h2>Volume Analysis (Current Candle)</h2>
                <div class="volume-bars">
                    <div class="volume-bar">
                        <div class="volume-label">Buy Volume</div>
                        <div class="volume-progress">
                            <div class="volume-fill buy" id="buyVolume" style="width: 0%">
                                <span id="buyVolumePercent">0%</span>
                            </div>
                        </div>
                        <div class="volume-value" id="buyVolumeValue">0</div>
                    </div>
                    <div class="volume-bar">
                        <div class="volume-label">Sell Volume</div>
                        <div class="volume-progress">
                            <div class="volume-fill sell" id="sellVolume" style="width: 0%">
                                <span id="sellVolumePercent">0%</span>
                            </div>
                        </div>
                        <div class="volume-value" id="sellVolumeValue">0</div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2>Statistics</h2>
                <div class="metrics">
                    <div class="metric">
                        <span class="label">Total Points</span>
                        <span class="value" id="totalPoints">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">Max CVD</span>
                        <span class="value positive" id="maxCVD">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">Min CVD</span>
                        <span class="value negative" id="minCVD">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">Avg Volume</span>
                        <span class="value" id="avgVolume">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let combinedChart = null;
        let deltaChart = null;
        let ws = null;
        let isTracking = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;

        let chartData = {
            timestamps: [],
            prices: [],
            cvdValues: [],
            deltas: [],
            buyVolumes: [],
            sellVolumes: []
        };

        const MAX_DATA_POINTS = 500;

        // ============================================
        // INITIALIZATION - CRITICAL ORDER
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ Initializing CVD Monitor...');
            
            // ðŸ”´ CRITICAL: Initialize charts FIRST
            initCharts();
            
            // Then connect WebSocket
            connectWebSocket();
            
            console.log('âœ… Initialization complete');
        });

        // ============================================
        // CHART INITIALIZATION
        // ============================================
        function initCharts() {
            console.log('ðŸ“Š Initializing charts...');
            
            const darkTheme = {
                theme: {
                    mode: 'dark',
                    palette: 'palette1'
                },
                chart: {
                    background: 'transparent',
                    foreColor: '#8b9dc3',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    }
                },
                grid: {
                    borderColor: '#2a3f5f',
                    strokeDashArray: 3
                }
            };

            // Combined Chart (Price + CVD with Dual Axis)
            const combinedOptions = {
                ...darkTheme,
                series: [
                    { name: 'Price', type: 'line', data: [] },
                    { name: 'CVD', type: 'area', data: [] }
                ],
                chart: {
                    ...darkTheme.chart,
                    id: 'combined-realtime',
                    height: 450,
                    type: 'line',
                    stacked: false,
                    animations: {
                        enabled: true,
                        easing: 'linear',
                        dynamicAnimation: { speed: 300 }
                    },
                    zoom: {
                        enabled: true,
                        type: 'x',
                        autoScaleYaxis: true
                    }
                },
                dataLabels: { enabled: false },
                stroke: {
                    width: [3, 2],
                    curve: 'smooth',
                    colors: ['#00ff88', '#3b82f6']
                },
                fill: {
                    opacity: [1, 0.3],
                    type: ['solid', 'gradient'],
                    gradient: {
                        shade: 'dark',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#00ff88', '#1e40af'],
                        inverseColors: false,
                        opacityFrom: [1, 0.6],
                        opacityTo: [1, 0.1],
                        stops: [0, 100]
                    }
                },
                colors: ['#00ff88', '#3b82f6'],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeFormatter: {
                            hour: 'HH:mm',
                            minute: 'HH:mm'
                        },
                        style: {
                            colors: '#8b9dc3'
                        }
                    }
                },
                yaxis: [
                    {
                        seriesName: 'CVD',
                        opposite: false,
                        axisBorder: { show: true, color: '#3b82f6' },
                        labels: {
                            style: { colors: '#3b82f6', fontSize: '12px' },
                            formatter: (value) => value.toFixed(0)
                        },
                        title: { text: 'CVD', style: { color: '#3b82f6' } }
                    },
                    {
                        seriesName: 'Price',
                        opposite: true,
                        axisBorder: { show: true, color: '#00ff88' },
                        labels: {
                            style: { colors: '#00ff88', fontSize: '12px' },
                            formatter: (value) => '$' + value.toFixed(2)
                        },
                        title: { text: 'Price (USDT)', style: { color: '#00ff88' } }
                    }
                ],
                legend: {
                    show: true,
                    position: 'top',
                    horizontalAlign: 'right',
                    labels: { colors: ['#00ff88', '#3b82f6'] }
                },
                tooltip: {
                    theme: 'dark',
                    shared: true,
                    x: { format: 'HH:mm:ss' }
                }
            };

            combinedChart = new ApexCharts(
                document.querySelector("#combinedChart"),
                combinedOptions
            );
            combinedChart.render();
            console.log('âœ… Combined chart created');

            // Delta Chart
            const deltaOptions = {
                ...darkTheme,
                series: [{ name: 'Delta', data: [] }],
                chart: {
                    ...darkTheme.chart,
                    id: 'delta-realtime',
                    height: 300,
                    type: 'bar',
                    animations: { enabled: true }
                },
                plotOptions: {
                    bar: {
                        colors: {
                            ranges: [
                                { from: -1000000, to: 0, color: '#ff4444' },
                                { from: 0.01, to: 1000000, color: '#00ff88' }
                            ]
                        }
                    }
                },
                xaxis: { type: 'datetime' },
                yaxis: { labels: { formatter: (value) => value.toFixed(0) } },
                tooltip: { theme: 'dark' }
            };

            deltaChart = new ApexCharts(
                document.querySelector("#deltaChart"),
                deltaOptions
            );
            deltaChart.render();
            console.log('âœ… Delta chart created');
        }

        // ============================================
        // WEBSOCKET CONNECTION
        // ============================================
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
           // const wsUrl = `${protocol}//${window.location.host}`;
const wsUrl = `${protocol}//localhost:5500`
            console.log(`ðŸ”Œ Connecting to: ${wsUrl}`);

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('âœ… WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('âŒ Parse error:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('âŒ WebSocket error:', error);
                updateConnectionStatus(false);
            };

            ws.onclose = () => {
                console.log('ðŸ”Œ WebSocket closed');
                updateConnectionStatus(false);
                reconnectWebSocket();
            };
        }

        function reconnectWebSocket() {
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                console.error('âŒ Max reconnection attempts reached');
                return;
            }

            reconnectAttempts++;
            const delay = Math.min(1000 * reconnectAttempts, 5000);
            
            console.log(`ðŸ”„ Reconnecting in ${delay}ms (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
            setTimeout(connectWebSocket, delay);
        }

        // ============================================
        // MESSAGE HANDLER
        // ============================================
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'initialState':
                    console.log('ðŸ“¦ Initial state:', message.data);
                    updateMetricsFromState(message.data);
                    break;

                case 'cvdUpdate':
                    handleCVDUpdate(message.data);
                    break;

                case 'candleClosed':
                    handleCandleClosed(message.data);
                    break;

                default:
                    console.warn('âš ï¸ Unknown message type:', message.type);
            }
        }

        function handleCVDUpdate(data) {
            // Update price
            const priceEl = document.getElementById('price');
            if (priceEl && data.price) {
                priceEl.textContent = '$' + data.price.toFixed(2);
            }

            // Update CVD
            const cvdEl = document.getElementById('cvd');
            if (cvdEl && data.cvd !== undefined) {
                cvdEl.textContent = data.cvd.toFixed(0);
                cvdEl.className = 'value ' + (data.cvd >= 0 ? 'positive' : 'negative');
            }

            // Show live indicator
            const liveEl = document.getElementById('liveIndicator');
            if (liveEl) {
                liveEl.style.display = 'flex';
            }
        }

        function handleCandleClosed(data) {
            console.log(`ðŸ•¯ï¸ Candle closed: ${data.timeframe}`);

            // Process 5m candles for chart
            if (data.timeframe === '5m') {
                const { candle } = data;
                const timestamp = new Date(candle.timestamp).getTime();

                // Add data
                chartData.timestamps.push(timestamp);
                chartData.prices.push(candle.close);
                chartData.cvdValues.push(candle.cvdClose);
                chartData.deltas.push(candle.cvdDelta);
                chartData.buyVolumes.push(candle.buyVolume || 0);
                chartData.sellVolumes.push(candle.sellVolume || 0);

                // Keep max points
                if (chartData.timestamps.length > MAX_DATA_POINTS) {
                    chartData.timestamps.shift();
                    chartData.prices.shift();
                    chartData.cvdValues.shift();
                    chartData.deltas.shift();
                    chartData.buyVolumes.shift();
                    chartData.sellVolumes.shift();
                }

                // Update UI
                updateCharts();
                updateVolumeBars(candle);
                updateDeltaDisplay(candle.cvdDelta);
            }
        }

        // ============================================
        // CHART UPDATES
        // ============================================
        function updateCharts() {
            const priceData = chartData.timestamps.map((ts, i) => ({
                x: ts,
                y: chartData.prices[i]
            }));

            const cvdData = chartData.timestamps.map((ts, i) => ({
                x: ts,
                y: chartData.cvdValues[i]
            }));

            const deltaData = chartData.timestamps.map((ts, i) => ({
                x: ts,
                y: chartData.deltas[i]
            }));

            if (combinedChart) {
                combinedChart.updateSeries([
                    { name: 'Price', data: priceData },
                    { name: 'CVD', data: cvdData }
                ]);
            }

            if (deltaChart) {
                deltaChart.updateSeries([
                    { name: 'Delta', data: deltaData }
                ]);
            }

            updateStatistics();
            console.log(`âœ… Charts updated (${chartData.timestamps.length} candles)`);
        }

        function updateVolumeBars(candle) {
            const buyVol = candle.buyVolume || 0;
            const sellVol = candle.sellVolume || 0;
            const totalVol = buyVol + sellVol;

            if (totalVol === 0) return;

            const buyPercent = (buyVol / totalVol) * 100;
            const sellPercent = (sellVol / totalVol) * 100;

            document.getElementById('buyVolume').style.width = buyPercent + '%';
            document.getElementById('buyVolumePercent').textContent = buyPercent.toFixed(1) + '%';
            document.getElementById('buyVolumeValue').textContent = buyVol.toFixed(4);

            document.getElementById('sellVolume').style.width = sellPercent + '%';
            document.getElementById('sellVolumePercent').textContent = sellPercent.toFixed(1) + '%';
            document.getElementById('sellVolumeValue').textContent = sellVol.toFixed(4);
        }

        function updateDeltaDisplay(delta) {
            const deltaEl = document.getElementById('delta');
            if (deltaEl) {
                deltaEl.textContent = (delta > 0 ? '+' : '') + delta.toFixed(0);
                deltaEl.className = 'value ' + (delta >= 0 ? 'positive' : 'negative');
            }
        }

        function updateStatistics() {
            const cvdValues = chartData.cvdValues;

            if (cvdValues.length === 0) return;

            const maxCVD = Math.max(...cvdValues);
            const minCVD = Math.min(...cvdValues);
            const avgVolume = chartData.buyVolumes.reduce((a, b) => a + b, 0) / Math.max(chartData.buyVolumes.length, 1);

            document.getElementById('totalPoints').textContent = cvdValues.length;
            document.getElementById('maxCVD').textContent = maxCVD.toFixed(2);
            document.getElementById('minCVD').textContent = minCVD.toFixed(2);
            document.getElementById('avgVolume').textContent = avgVolume.toFixed(4);
        }

        // ============================================
        // CONTROL FUNCTIONS
        // ============================================
        function startTracking() {
            if (isTracking) return;
            isTracking = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            console.log('âœ… Tracking started');
        }

        function stopTracking() {
            if (!isTracking) return;
            isTracking = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            console.log('â¹ Tracking stopped');
        }

        function resetChart() {
            stopTracking();

            chartData = {
                timestamps: [],
                prices: [],
                cvdValues: [],
                deltas: [],
                buyVolumes: [],
                sellVolumes: []
            };

            if (combinedChart) {
                combinedChart.updateSeries([
                    { name: 'Price', data: [] },
                    { name: 'CVD', data: [] }
                ]);
            }

            if (deltaChart) {
                deltaChart.updateSeries([
                    { name: 'Delta', data: [] }
                ]);
            }

            document.getElementById('price').textContent = '-';
            document.getElementById('cvd').textContent = '-';
            document.getElementById('delta').textContent = '-';
            document.getElementById('trades').textContent = '-';
            document.getElementById('totalPoints').textContent = '0';
            document.getElementById('maxCVD').textContent = '0';
            document.getElementById('minCVD').textContent = '0';
            document.getElementById('avgVolume').textContent = '0';

            console.log('ðŸ”„ Chart reset');
        }

        function exportCSV() {
            if (chartData.cvdValues.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = 'Timestamp,Price,CVD,Delta,BuyVolume,SellVolume\n';

            chartData.timestamps.forEach((ts, idx) => {
                const date = new Date(ts).toISOString();
                csv += `"${date}",${chartData.prices[idx]},${chartData.cvdValues[idx]},${chartData.deltas[idx]},${chartData.buyVolumes[idx]},${chartData.sellVolumes[idx]}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cvd-data-${Date.now()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            console.log('ðŸ“¥ Exported CSV');
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('status');
            if (connected) {
                statusEl.textContent = 'ðŸŸ¢ Connected';
                statusEl.classList.add('connected');
            } else {
                statusEl.textContent = 'ðŸ”´ Disconnected';
                statusEl.classList.remove('connected');
            }
        }

        function updateMetricsFromState(state) {
            if (state.currentPrice > 0) {
                document.getElementById('price').textContent = '$' + state.currentPrice.toFixed(2);
            }
            document.getElementById('cvd').textContent = state.cvdTotal.toFixed(0);
            document.getElementById('trades').textContent = state.tradesCount;
            document.getElementById('symbol').textContent = state.symbol || 'BTC/USDT';
        }

        // ============================================
        // CLEANUP
        // ============================================
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (combinedChart) combinedChart.destroy();
            if (deltaChart) deltaChart.destroy();
            console.log('ðŸ§¹ Cleanup complete');
        });

        console.log('âš¡ CVD Monitor loaded and ready');
    </script>
</body>
</html>
